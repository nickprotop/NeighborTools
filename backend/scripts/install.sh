#!/bin/bash

# NeighborTools Complete Installation Script
# Run this once for initial project setup

set -e  # Exit on any error

echo "üöÄ Installing NeighborTools - Complete Setup"
echo "============================================="

# Check if Docker and Docker Compose are installed
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker is not installed. Please install Docker first."
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "‚ùå Docker Compose is not installed. Please install Docker Compose first."
    exit 1
fi

# Check if .NET SDK is installed
if ! command -v dotnet &> /dev/null; then
    echo "‚ùå .NET SDK is not installed. Please install .NET 9 SDK first."
    exit 1
fi

echo "‚úÖ Prerequisites check passed"
echo ""

# Database password configuration
echo "üîê Database Configuration"
echo "========================"
echo "Configure passwords for the MySQL database setup."
echo "Press Enter to use default passwords (recommended for development)."
echo ""

# Function to read password with optional default
read_password() {
    local prompt="$1"
    local default="$2"
    local password
    
    while true; do
        echo -n "$prompt" >&2
        if [ -n "$default" ]; then
            echo -n " [default: $default]: " >&2
        else
            echo -n ": " >&2
        fi
        
        read -s password
        echo "" >&2  # New line after hidden input
        
        if [ -z "$password" ] && [ -n "$default" ]; then
            echo "$default"
            return
        elif [ -n "$password" ]; then
            echo "$password"
            return
        else
            echo "Please enter a password or press Enter for default." >&2
        fi
    done
}

# Get MySQL root password
MYSQL_ROOT_PASSWORD=$(read_password "MySQL root password" "RootPassword123!")

# Get MySQL user password
MYSQL_USER_PASSWORD=$(read_password "MySQL toolsuser password" "ToolsPassword123!")

echo ""
echo "üåê Blazor WASM App Configuration"
echo "==============================="
echo "Configure the Blazor WebAssembly app URL for development."
echo ""

# Function to read text input with default
read_input() {
    local prompt="$1"
    local default="$2"
    local input
    
    echo -n "$prompt" >&2
    if [ -n "$default" ]; then
        echo -n " [default: $default]: " >&2
    else
        echo -n ": " >&2
    fi
    
    read input
    
    if [ -z "$input" ] && [ -n "$default" ]; then
        echo "$default"
    else
        echo "$input"
    fi
}

FRONTEND_BASE_URL=$(read_input "Blazor WASM app URL" "http://localhost:5000")

echo ""
echo "‚úÖ Configuration complete"
echo "================================================"
echo "Review your configuration:"
echo "   MySQL root password: $(echo "$MYSQL_ROOT_PASSWORD" | sed 's/./*/g')"
echo "   MySQL user password: $(echo "$MYSQL_USER_PASSWORD" | sed 's/./*/g')"
echo "   Blazor WASM app URL: $FRONTEND_BASE_URL"
echo "================================================"
echo ""
echo -n "Proceed with installation? [Y/n]: " >&2
read -r confirm
echo ""

if [[ "$confirm" =~ ^[Nn]$ ]]; then
    echo "‚ùå Installation cancelled by user."
    exit 0
fi

echo "üöÄ Starting installation..."

# Create .env file for docker-compose
DOCKER_DIR="$(dirname "$0")/../docker"
ENV_FILE="$DOCKER_DIR/.env"

echo "üìù Creating .env file for docker-compose..."
cat > "$ENV_FILE" << EOF
# Docker Compose Environment Variables
# Generated by install script on $(date)

# MySQL Configuration
MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
MYSQL_USER_PASSWORD=$MYSQL_USER_PASSWORD

# Note: This file is automatically read by docker-compose
EOF

echo "‚úÖ Created .env file: $ENV_FILE"

# Navigate to the docker directory
cd "$DOCKER_DIR"

# Stop any existing containers
echo "üßπ Cleaning up existing containers..."
docker-compose down --remove-orphans

# Install infrastructure (MySQL, Redis)
echo "üì¶ Setting up infrastructure (MySQL, Redis)..."
docker-compose --profile infrastructure up -d

# Wait for MySQL to be ready
echo "‚è≥ Waiting for MySQL to be ready..."
for i in {1..30}; do
    if docker-compose exec -T mysql mysqladmin ping -h localhost --silent; then
        echo "‚úÖ MySQL is ready"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "‚ùå MySQL failed to start within 30 seconds"
        exit 1
    fi
    echo "   Waiting... ($i/30)"
    sleep 1
done

# Wait for Redis to be ready
echo "‚è≥ Waiting for Redis to be ready..."
for i in {1..10}; do
    if docker-compose exec -T redis redis-cli ping | grep -q "PONG"; then
        echo "‚úÖ Redis is ready"
        break
    fi
    if [ $i -eq 10 ]; then
        echo "‚ùå Redis failed to start within 10 seconds"
        exit 1
    fi
    echo "   Waiting... ($i/10)"
    sleep 1
done

# Navigate back to backend root
cd ..

# Install .NET dependencies
echo "üì¶ Installing .NET dependencies..."
dotnet restore

# Update backend configuration with database password
echo "üìù Updating backend configuration..."
cd src/ToolsSharing.API

# Check if config.json exists, if not create it from sample
if [ ! -f "config.json" ]; then
    if [ -f "config.sample.json" ]; then
        cp config.sample.json config.json
        echo "‚úÖ Created config.json from sample"
    else
        echo "‚ùå config.sample.json not found. Cannot create config.json"
        exit 1
    fi
fi

# Update the database connection string and Blazor WASM app URL in config.json
CONNECTION_STRING="server=localhost;port=3306;database=toolssharing;uid=toolsuser;pwd=${MYSQL_USER_PASSWORD}"
if command -v jq &> /dev/null; then
    # Use jq if available for proper JSON manipulation
    tmp=$(mktemp)
    jq --arg conn "$CONNECTION_STRING" --arg frontend "$FRONTEND_BASE_URL" \
       '.ConnectionStrings.DefaultConnection = $conn | .Frontend.BaseUrl = $frontend' \
       config.json > "$tmp" && mv "$tmp" config.json
    echo "‚úÖ Updated database connection string and Blazor WASM app URL in config.json (using jq)"
else
    # Fallback to sed for basic replacement
    sed -i "s|\"DefaultConnection\": \".*\"|\"DefaultConnection\": \"$CONNECTION_STRING\"|g" config.json
    sed -i "s|\"BaseUrl\": \".*\"|\"BaseUrl\": \"$FRONTEND_BASE_URL\"|g" config.json
    echo "‚úÖ Updated database connection string and Blazor WASM app URL in config.json (using sed)"
fi

cd ../..

# Apply database migrations (essential system data included)
echo "üóÑÔ∏è Running database migrations with essential system data..."
dotnet run --project src/ToolsSharing.API --seed-only

echo ""
echo "üéâ Installation completed successfully!"
echo "============================================="
echo "Database Configuration:"
echo "  ‚Ä¢ MySQL Root Password: $(echo "$MYSQL_ROOT_PASSWORD" | sed 's/./*/g')"
echo "  ‚Ä¢ MySQL User Password: $(echo "$MYSQL_USER_PASSWORD" | sed 's/./*/g')"
echo ""
echo "Next steps:"
echo "  ‚Ä¢ Run './start-all.sh' to start development environment"
echo "  ‚Ä¢ Or run './start-infrastructure.sh' + 'dotnet run' for API debugging"
echo "  ‚Ä¢ Access Swagger UI at: http://localhost:5002/swagger"
echo "  ‚Ä¢ Blazor WASM app will be available at: $FRONTEND_BASE_URL"
echo "  ‚Ä¢ MySQL: localhost:3306 (user: toolsuser, password: [configured above])"
echo "  ‚Ä¢ Redis: localhost:6379"
echo ""
echo "Admin Access:"
echo "  ‚Ä¢ Essential admin user created: admin@neighbortools.com / Admin123!"
echo "  ‚Ä¢ Essential data (roles, tool categories) installed automatically"
echo "  ‚Ä¢ Use Admin Panel ‚Üí Sample Data Management to add/remove test data"
echo "  ‚Ä¢ Optional: Add sample users (john.doe@email.com, jane.smith@email.com) via admin panel"
echo ""
echo "Configuration Files Updated:"
echo "  ‚Ä¢ Docker Compose: Uses environment variables with fallback to defaults"
echo "  ‚Ä¢ Backend config.json: Updated with database password and Blazor WASM app URL"
echo ""
echo "Happy coding! üöÄ"