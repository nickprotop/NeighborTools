@page "/bundles/{BundleId:guid}"
@using Microsoft.AspNetCore.Authorization
@using ToolsSharing.Frontend.Models
@using frontend.Models
@using ToolsSharing.Frontend.Services
@using frontend.Services
@using frontend.Components.Bundles
@using frontend.Components
@using frontend.Components.Common
@inject BundleService BundleService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@inject IUrlService UrlService
@inject IBreadcrumbService BreadcrumbService
@attribute [AllowAnonymous]

<PageTitle>@(bundle?.Name ?? "Bundle") - NeighborTools</PageTitle>

<style>
    .tool-link {
        font-weight: 500 !important;
        text-decoration: none !important;
        transition: all 0.2s ease !important;
    }
    
    .tool-link:hover {
        text-decoration: underline !important;
        color: var(--mud-palette-primary-darken) !important;
    }
</style>

@if (isLoading)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
    </MudContainer>
}
else if (bundle == null)
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
        <MudStack AlignItems="AlignItems.Center" Class="pa-8">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h5" Class="mt-4">Bundle Not Found</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                The bundle you're looking for doesn't exist or has been removed.
            </MudText>
            <MudButton Variant="Variant.Filled" 
                     Color="Color.Primary" 
                     Href="/bundles" 
                     Class="mt-4">
                Browse All Bundles
            </MudButton>
        </MudStack>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
        <!-- Breadcrumb -->
        <BreadcrumbNavigation Items="@breadcrumbItems" />
        <MudGrid>
            <!-- Header Section -->
            <MudItem xs="12">
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Class="mb-4">
                    <div>
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.h4" Color="Color.Primary">@bundle.Name</MudText>
                            @if (bundle.IsFeatured)
                            {
                                <MudChip Color="Color.Warning" Size="Size.Medium" Icon="@Icons.Material.Filled.Star" Text="Featured" T="string" />
                            }
                            
                            <!-- Bundle Approval Status - Show for owner if not approved -->
                            @if (isOwner && !bundle.IsApproved)
                            {
                                @if (bundle.PendingApproval)
                                {
                                    <MudChip Color="Color.Warning" 
                                           Size="Size.Medium" 
                                           Icon="@Icons.Material.Filled.HourglassEmpty" 
                                           Text="Pending Approval" 
                                           T="string" />
                                }
                                else
                                {
                                    <MudTooltip Text="@(!string.IsNullOrEmpty(bundle.RejectionReason) ? $"Rejected: {bundle.RejectionReason}" : "This bundle was rejected and needs to be reviewed")">
                                        <MudChip Color="Color.Error" 
                                               Size="Size.Medium" 
                                               Icon="@Icons.Material.Filled.Block" 
                                               Text="Rejected" 
                                               T="string" />
                                    </MudTooltip>
                                }
                            }
                        </MudStack>
                        
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudChip Color="Color.Primary" Text="@bundle.Category" T="string" />
                            <MudChip Color="Color.Secondary" Text="@bundle.RequiredSkillLevel" T="string" />
                            <MudChip Color="Color.Info" Text="@($"{bundle.EstimatedProjectDuration}h project")" T="string" />
                        </MudStack>

                        <MudStack Row Spacing="4" AlignItems="AlignItems.Center">
                            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@bundle.OwnerName</MudText>
                            </MudStack>
                            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Color="Color.Secondary" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@bundle.OwnerLocation</MudText>
                            </MudStack>
                        </MudStack>
                    </div>

                    <MudStack Spacing="2" AlignItems="AlignItems.End">
                        <!-- Pricing -->
                        <div style="text-align: right;">
                            @if (bundle.BundleDiscount > 0)
                            {
                                <MudText Typo="Typo.body2" 
                                       Style="text-decoration: line-through;" 
                                       Color="Color.Secondary">
                                    $@bundle.TotalCost.ToString("F2")/day
                                </MudText>
                                <MudStack Row Spacing="1" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd">
                                    <MudText Typo="Typo.h5" Color="Color.Primary">
                                        $@bundle.DiscountedCost.ToString("F2")/day
                                    </MudText>
                                    <MudChip Size="Size.Small" 
                                           Color="Color.Success" 
                                           Text="@($"-{bundle.BundleDiscount:F0}%")" 
                                           T="string" />
                                </MudStack>
                            }
                            else
                            {
                                <MudText Typo="Typo.h5" Color="Color.Primary">
                                    $@bundle.DiscountedCost.ToString("F2")/day
                                </MudText>
                            }
                        </div>

                        <!-- Availability Status -->
                        @if (isCheckingAvailability)
                        {
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudChip Color="Color.Info" 
                                       Size="Size.Medium" 
                                       Icon="@Icons.Material.Filled.Refresh" 
                                       Text="Checking Availability..." 
                                       T="string" />
                            </MudStack>
                        }
                        else if (bundle.IsAvailable)
                        {
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudChip Color="Color.Success" 
                                       Size="Size.Medium" 
                                       Icon="@Icons.Material.Filled.CheckCircle" 
                                       Text="Available Now" 
                                       T="string" />
                                @if (quickAvailability != null)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        (Next 3 days checked)
                                    </MudText>
                                }
                            </MudStack>
                        }
                        else if (bundle.AvailableFromDate.HasValue)
                        {
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudChip Color="Color.Warning" 
                                       Size="Size.Medium" 
                                       Icon="@Icons.Material.Filled.Schedule" 
                                       Text="@($"Available {bundle.AvailableFromDate.Value:MMM dd}")" 
                                       T="string" />
                                @if (quickAvailability?.ToolAvailability.Any(t => !t.IsAvailable) == true)
                                {
                                    <MudTooltip Text="@GetUnavailableToolsTooltip()">
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Secondary" />
                                    </MudTooltip>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudChip Color="Color.Error" 
                                       Size="Size.Medium" 
                                       Icon="@Icons.Material.Filled.Block" 
                                       Text="Currently Unavailable" 
                                       T="string" />
                                @if (quickAvailability?.ToolAvailability.Any(t => !t.IsAvailable) == true)
                                {
                                    <MudTooltip Text="@GetUnavailableToolsTooltip()">
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Error" />
                                    </MudTooltip>
                                }
                            </MudStack>
                        }

                        <!-- Action Buttons -->
                        <AuthorizeView>
                            <Authorized>
                                @if (isOwner)
                                {
                                    <MudStack Row Spacing="2">
                                        <MudButton Variant="Variant.Outlined" 
                                                 Color="Color.Secondary" 
                                                 StartIcon="@Icons.Material.Filled.Edit"
                                                 OnClick="EditBundle">
                                            Edit
                                        </MudButton>
                                        
                                        <MudButton Variant="Variant.Outlined" 
                                                 Color="Color.Error" 
                                                 StartIcon="@Icons.Material.Filled.Delete"
                                                 OnClick="DeleteBundle">
                                            Delete
                                        </MudButton>
                                    </MudStack>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Filled" 
                                             Color="Color.Primary" 
                                             Size="Size.Large"
                                             StartIcon="@Icons.Material.Filled.ShoppingCart"
                                             Disabled="!bundle.IsAvailable"
                                             OnClick="OpenRentalDialog">
                                        Rent Bundle
                                    </MudButton>
                                }
                            </Authorized>
                            <NotAuthorized>
                                <MudTooltip Text="You must be logged in to request bundle rentals">
                                    <MudButton Variant="Variant.Filled" 
                                             Color="Color.Primary" 
                                             Size="Size.Large"
                                             StartIcon="@Icons.Material.Filled.Login"
                                             Href="/login">
                                        Sign In to Rent
                                    </MudButton>
                                </MudTooltip>
                            </NotAuthorized>
                        </AuthorizeView>
                    </MudStack>
                </MudStack>
            </MudItem>

            <!-- Bundle Image -->
            <MudItem xs="12">
                <MudCard Class="mb-4">
                    <MudCardContent Class="pa-0">
                        <div style="position: relative; height: 300px; overflow: hidden; border-radius: 8px;">
                            @if (!string.IsNullOrEmpty(bundle.ImageUrl))
                            {
                                <img src="@UrlService.GetFileUrl(bundle.ImageUrl)" 
                                     style="width: 100%; height: 300px; object-fit: cover; @(bundleImageLoadError ? "display: none;" : "")"
                                     @onerror="HandleBundleImageError" 
                                     @onload="HandleBundleImageLoad" />
                            }
                            
                            @if (string.IsNullOrEmpty(bundle.ImageUrl) || bundleImageLoadError)
                            {
                                <ThemeAwarePlaceholder Height="300px" 
                                                      BorderRadius="8px"
                                                      Icon="@Icons.Material.Filled.Inventory" 
                                                      IconSize="Size.Large"
                                                      IconFontSize="4rem" />
                            }
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Main Content -->
            <MudItem xs="12" md="8">
                <!-- Description -->
                <MudCard Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Description</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body1" Style="white-space: pre-line;">@bundle.Description</MudText>
                    </MudCardContent>
                </MudCard>

                <!-- Guidelines -->
                @if (!string.IsNullOrWhiteSpace(bundle.Guidelines))
                {
                    <MudCard Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="mr-2" />
                                    Guidelines & Instructions
                                </MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body1" Style="white-space: pre-line;">@bundle.Guidelines</MudText>
                        </MudCardContent>
                    </MudCard>
                }

                <!-- Tools in Bundle -->
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@Icons.Material.Filled.Build" Class="mr-2" />
                                Tools Included (@bundle.Tools.Count)
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string">
                            @foreach (var tool in bundle.Tools.OrderBy(t => t.OrderInBundle))
                            {
                                <MudListItem T="string">
                                    <MudPaper Class="pa-3 mb-2" Elevation="1">
                                        <MudGrid AlignItems="Center">
                                            <MudItem xs="12" sm="8">
                                                <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                                                    @if (tool.IsOptional)
                                                    {
                                                        <MudChip Size="Size.Small" Color="Color.Info" Text="Optional" T="string" />
                                                    }
                                                    
                                                    @* Tool Approval Status - Show for owners *@
                                                    @if (isOwner)
                                                    {
                                                        var toolApprovalInfo = GetToolApprovalInfo(tool.ToolId);
                                                        if (toolApprovalInfo != null)
                                                        {
                                                            @if (toolApprovalInfo.IsPending)
                                                            {
                                                                <MudTooltip Text="This tool is pending approval">
                                                                    <MudChip Size="Size.Small" 
                                                                           Color="Color.Warning" 
                                                                           Icon="@Icons.Material.Filled.HourglassEmpty" 
                                                                           Text="Pending" 
                                                                           T="string" />
                                                                </MudTooltip>
                                                            }
                                                            else if (!string.IsNullOrEmpty(toolApprovalInfo.RejectionReason))
                                                            {
                                                                <MudTooltip Text="@($"Rejected: {toolApprovalInfo.RejectionReason}")">
                                                                    <MudChip Size="Size.Small" 
                                                                           Color="Color.Error" 
                                                                           Icon="@Icons.Material.Filled.Block" 
                                                                           Text="Rejected" 
                                                                           T="string" />
                                                                </MudTooltip>
                                                            }
                                                        }
                                                    }
                                                    
                                                    <div>
                                                        <MudLink Href="@($"/tools/{tool.ToolId}")" Typo="Typo.subtitle1" Color="Color.Primary" Underline="Underline.Hover" Class="tool-link">
                                                            @tool.ToolName
                                                        </MudLink>
                                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@tool.ToolDescription</MudText>
                                                        @if (!string.IsNullOrWhiteSpace(tool.UsageNotes))
                                                        {
                                                            <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-style: italic;">
                                                                Notes: @tool.UsageNotes
                                                            </MudText>
                                                        }
                                                    </div>
                                                </MudStack>
                                            </MudItem>
                                            <MudItem xs="6" sm="2">
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                    Qty: @tool.QuantityNeeded
                                                </MudText>
                                            </MudItem>
                                            <MudItem xs="6" sm="2">
                                                <MudText Typo="Typo.body2" Color="Color.Primary">
                                                    $@tool.DailyRate.ToString("F2")/day
                                                </MudText>
                                            </MudItem>
                                        </MudGrid>
                                    </MudPaper>
                                </MudListItem>
                            }
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Sidebar -->
            <MudItem xs="12" md="4">

                <!-- Tags -->
                @if (bundle.Tags.Any())
                {
                    <MudCard Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Tags</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Row Spacing="1" Wrap="Wrap.Wrap">
                                @foreach (var tag in bundle.Tags)
                                {
                                    <MudChip Size="Size.Small" Color="Color.Default" Text="@tag" T="string" />
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }

                <!-- Reviews -->
                <BundleReviewsComponent BundleId="@BundleId" 
                                       BundleName="@(bundle?.Name ?? "")" 
                                       CanReview="!isOwner" 
                                       IsAuthenticated="!string.IsNullOrEmpty(currentUserId)" />

                <!-- Actions -->
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Actions</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            @if (!isOwner)
                            {
                                <BundleFavoriteButton BundleId="@bundle.Id.ToString()" 
                                                     OwnerUserId="@bundle.UserId" 
                                                     Size="Size.Medium" />
                            }
                            else
                            {
                                <div></div>
                            }
                            
                            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                <MudIconButton Icon="@Icons.Custom.Brands.Facebook" 
                                             Color="Color.Primary" 
                                             Size="Size.Medium"
                                             OnClick="@(() => ShareBundle("facebook"))" />
                                <MudIconButton Icon="@Icons.Custom.Brands.Twitter" 
                                             Color="Color.Info" 
                                             Size="Size.Medium"
                                             OnClick="@(() => ShareBundle("twitter"))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Share" 
                                             Color="Color.Secondary" 
                                             Size="Size.Medium"
                                             OnClick="@(() => CopyLink())" />
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    [Parameter] public Guid BundleId { get; set; }
    
    private BundleModel? bundle;
    private bool isLoading = true;
    private bool isCheckingAvailability = false;
    private BundleAvailabilityResponseModel? quickAvailability;
    private bool isOwner = false;
    private string? currentUserId;
    private BundleApprovalStatusDto? bundleApprovalStatus;
    private bool bundleImageLoadError = false;
    private List<frontend.Models.BreadcrumbItem> breadcrumbItems = new();

    protected override async Task OnInitializedAsync()
    {
        // Get current user
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        
        await LoadBundle();
        if (bundle != null)
        {
            SetupBreadcrumbs();
            await CheckQuickAvailability();
            if (isOwner)
            {
                await LoadBundleApprovalStatus();
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (bundle?.Id != BundleId)
        {
            await LoadBundle();
            if (bundle != null)
            {
                SetupBreadcrumbs();
            }
        }
    }

    private async Task LoadBundle()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var result = await BundleService.GetBundleByIdAsync(BundleId);
            
            if (result.Success && result.Data != null)
            {
                bundle = result.Data;
                isOwner = bundle.UserId == currentUserId;
            }
            else
            {
                bundle = null;
                if (!string.IsNullOrEmpty(result.Message))
                {
                    Snackbar.Add(result.Message, Severity.Warning);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load bundle: {ex.Message}", Severity.Error);
            bundle = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ShareBundle(string platform)
    {
        var url = Navigation.Uri;
        var text = $"Check out this tool bundle: {bundle?.Name}";

        string shareUrl = platform switch
        {
            "facebook" => $"https://www.facebook.com/sharer/sharer.php?u={Uri.EscapeDataString(url)}",
            "twitter" => $"https://twitter.com/intent/tweet?text={Uri.EscapeDataString(text)}&url={Uri.EscapeDataString(url)}",
            _ => url
        };

        await Task.Run(() => Navigation.NavigateTo(shareUrl, true));
    }

    private async Task CopyLink()
    {
        try
        {
            // Use JavaScript interop for clipboard functionality in a real implementation
            await Task.Delay(100); // Simulate async operation
            Snackbar.Add("Link copied to clipboard!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Could not copy link", Severity.Warning);
        }
    }

    private async Task CheckQuickAvailability()
    {
        if (bundle == null) return;

        isCheckingAvailability = true;
        StateHasChanged();

        try
        {
            // Check availability for tomorrow to next week
            var startDate = DateTime.Today.AddDays(1);
            var endDate = DateTime.Today.AddDays(3); // 3-day rental

            var availabilityRequest = new BundleAvailabilityModel
            {
                BundleId = bundle.Id,
                StartDate = startDate,
                EndDate = endDate
            };

            var result = await BundleService.CheckBundleAvailabilityAsync(availabilityRequest);
            
            if (result.Success && result.Data != null)
            {
                quickAvailability = result.Data;
                
                // Update the bundle's availability properties based on real data
                bundle.IsAvailable = quickAvailability.IsAvailable;
                if (!quickAvailability.IsAvailable && quickAvailability.EarliestAvailableDate.HasValue)
                {
                    bundle.AvailableFromDate = quickAvailability.EarliestAvailableDate;
                }
            }
        }
        catch (Exception ex)
        {
            // Silently fail for availability check - don't disrupt the page load
            Console.WriteLine($"Failed to check bundle availability: {ex.Message}");
        }
        finally
        {
            isCheckingAvailability = false;
            StateHasChanged();
        }
    }

    private async Task OpenRentalDialog()
    {
        if (bundle == null) return;

        var parameters = new DialogParameters { { "Bundle", bundle } };
        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = DialogService.Show<BundleRentalRequestDialog>("Request Bundle Rental", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            // Bundle rental request was successful
            // The dialog handles navigation to the bundle rental details
            Snackbar.Add("Bundle rental request submitted successfully!", Severity.Success);
            
            // Refresh availability after successful rental
            await CheckQuickAvailability();
        }
    }

    private string GetUnavailableToolsTooltip()
    {
        if (quickAvailability?.ToolAvailability == null) 
            return "Check specific dates for detailed availability";

        var unavailableTools = quickAvailability.ToolAvailability
            .Where(t => !t.IsAvailable)
            .Select(t => $"{t.ToolName}: {t.UnavailabilityReason}")
            .ToList();

        if (!unavailableTools.Any())
            return "All tools available";

        return $"Unavailable tools:\n{string.Join("\n", unavailableTools)}";
    }

    private void EditBundle()
    {
        if (bundle != null)
        {
            Navigation.NavigateTo($"/bundles/{bundle.Id}/edit");
        }
    }

    private async Task LoadBundleApprovalStatus()
    {
        if (bundle == null) return;

        try
        {
            var result = await BundleService.GetBundleApprovalStatusAsync(bundle.Id);
            if (result.Success && result.Data != null)
            {
                bundleApprovalStatus = result.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load bundle approval status: {ex.Message}");
            // Silently fail - don't disrupt the main page load
        }
    }

    private UnapprovedToolInfo? GetToolApprovalInfo(Guid toolId)
    {
        return bundleApprovalStatus?.UnapprovedTools.FirstOrDefault(t => t.ToolId == toolId);
    }

    private async Task DeleteBundle()
    {
        if (bundle == null) return;

        var parameters = new DialogParameters
        {
            { "Title", "Delete Bundle" },
            { "Message", $"Are you sure you want to delete '{bundle.Name}'? This action cannot be undone." },
            { "ConfirmText", "Delete" },
            { "ConfirmColor", Color.Error }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = DialogService.Show<frontend.Components.ConfirmationDialog>("Delete Bundle", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is frontend.Models.ConfirmationDialogResult dialogResult && dialogResult.Confirmed)
        {
            try
            {
                var deleteResult = await BundleService.DeleteBundleAsync(bundle.Id);
                
                if (deleteResult.Success)
                {
                    Snackbar.Add($"Bundle '{bundle.Name}' deleted successfully", Severity.Success);
                    Navigation.NavigateTo("/my-bundles");
                }
                else
                {
                    Snackbar.Add(deleteResult.Message ?? "Failed to delete bundle", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete bundle: {ex.Message}", Severity.Error);
            }
        }
    }
    
    private void HandleBundleImageError()
    {
        bundleImageLoadError = true;
        StateHasChanged();
    }
    
    private void HandleBundleImageLoad()
    {
        bundleImageLoadError = false;
        StateHasChanged();
    }

    private void SetupBreadcrumbs()
    {
        if (bundle != null)
        {
            breadcrumbItems = BreadcrumbService.GenerateBundlesBreadcrumb(
                bundleName: bundle.Name,
                category: bundle.Category,
                page: BreadcrumbPage.Details);
        }
    }
}