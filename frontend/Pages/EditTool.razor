@page "/tools/edit/{id}"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using frontend.Models
@using frontend.Services
@inject IToolService ToolService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Edit Tool - NeighborTools</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Elevation="8" Class="pa-8" Style="border-radius: 16px;">
        @if (isLoading)
        {
            <div class="d-flex flex-column align-center justify-center" style="min-height: 300px;">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.h6" Class="mt-4">Loading tool details...</MudText>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="(() => errorMessage = string.Empty)">
                @errorMessage
            </MudAlert>
        }
        else
        {
            <!-- Header -->
            <div class="d-flex flex-column align-center mb-6">
                <MudIcon Icon="Icons.Material.Filled.Edit" Size="Size.Large" Color="Color.Primary" Class="mb-4" Style="font-size: 4rem;" />
                <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">
                    Edit Tool
                </MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center">
                    Update your tool details to keep your listing current and attractive!
                </MudText>
            </div>

            <EditForm Model="updateToolRequest" OnValidSubmit="HandleUpdateTool">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(submitErrorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="(() => submitErrorMessage = string.Empty)">
                        @submitErrorMessage
                    </MudAlert>
                }

                <MudTabs Elevation="4" Rounded="true" Color="Color.Primary">
                    <!-- Basic Information Tab -->
                    <MudTabPanel Text="Basic Info" Icon="Icons.Material.Filled.Info">
                        <div class="pa-4">
                            <MudGrid>
                                <MudItem xs="12" md="8">
                                    <MudTextField @bind-Value="updateToolRequest.Name"
                                                  Label="Tool Name"
                                                  Variant="Variant.Outlined"
                                                  FullWidth="true"
                                                  Required="true"
                                                  RequiredError="Tool name is required"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.Build"
                                                  Class="mb-4" />

                                    <MudTextField @bind-Value="updateToolRequest.Description"
                                                  Label="Description"
                                                  Variant="Variant.Outlined"
                                                  Lines="4"
                                                  FullWidth="true"
                                                  Required="true"
                                                  RequiredError="Description is required"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.Description"
                                                  Class="mb-4" />

                                    <MudGrid>
                                        <MudItem xs="12" sm="6">
                                            <MudSelect @bind-Value="updateToolRequest.Category" 
                                                       Label="Category" 
                                                       Variant="Variant.Outlined" 
                                                       Required="true"
                                                       RequiredError="Category is required"
                                                       AdornmentIcon="@Icons.Material.Filled.Category" 
                                                       Adornment="Adornment.Start">
                                                <MudSelectItem T="string" Value="@("Power Tools")">Power Tools</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Hand Tools")">Hand Tools</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Garden Tools")">Garden Tools</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Automotive")">Automotive</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Construction")">Construction</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Home Improvement")">Home Improvement</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Cleaning")">Cleaning</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Other")">Other</MudSelectItem>
                                            </MudSelect>
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudSelect @bind-Value="updateToolRequest.Condition" 
                                                       Label="Condition" 
                                                       Variant="Variant.Outlined" 
                                                       Required="true"
                                                       AdornmentIcon="@Icons.Material.Filled.Assessment" 
                                                       Adornment="Adornment.Start"
                                                       RequiredError="Condition is required">
                                                <MudSelectItem T="string" Value="@("Excellent")">Excellent</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Very Good")">Very Good</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Good")">Good</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Fair")">Fair</MudSelectItem>
                                                <MudSelectItem T="string" Value="@("Poor")">Poor</MudSelectItem>
                                            </MudSelect>
                                        </MudItem>
                                    </MudGrid>
                                </MudItem>
                                
                                <MudItem xs="12" md="4">
                                    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; background: var(--mud-palette-surface-variant);">
                                        <MudText Typo="Typo.h6" Class="mb-3" Color="Color.Primary">
                                            <MudIcon Icon="Icons.Material.Filled.Tips" Class="mr-2" />
                                            Edit Tips
                                        </MudText>
                                        <MudList T="string" Dense="true">
                                            <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                                                Keep information current
                                            </MudListItem>
                                            <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                                                Update condition honestly
                                            </MudListItem>
                                            <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                                                Adjust pricing as needed
                                            </MudListItem>
                                            <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                                                Add new photos if helpful
                                            </MudListItem>
                                        </MudList>
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>
                        </div>
                    </MudTabPanel>

                    <!-- Details Tab -->
                    <MudTabPanel Text="Details" Icon="Icons.Material.Filled.Settings">
                        <div class="pa-4">
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="updateToolRequest.Brand"
                                                  Label="Brand"
                                                  Variant="Variant.Outlined"
                                                  FullWidth="true"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.Business"
                                                  Class="mb-4" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="updateToolRequest.Model"
                                                  Label="Model"
                                                  Variant="Variant.Outlined"
                                                  FullWidth="true"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.ModelTraining"
                                                  Class="mb-4" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="updateToolRequest.Location"
                                                  Label="Location"
                                                  Variant="Variant.Outlined"
                                                  FullWidth="true"
                                                  Required="true"
                                                  RequiredError="Location is required"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.LocationOn"
                                                  HelperText="Location where the tool is available (can be updated from your public profile location)"
                                                  Class="mb-4" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudSwitch @bind-Value="updateToolRequest.IsAvailable"
                                               Label="Available for Rent"
                                               Color="Color.Success"
                                               UnCheckedColor="Color.Error"
                                               ThumbIcon="@(updateToolRequest.IsAvailable ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)"
                                               Class="mb-4" />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Toggle this to make your tool available or unavailable for rent
                                    </MudText>
                                </MudItem>
                            </MudGrid>
                        </div>
                    </MudTabPanel>

                    <!-- Pricing Tab -->
                    <MudTabPanel Text="Pricing" Icon="Icons.Material.Filled.AttachMoney">
                        <div class="pa-4">
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudAlert Severity="Severity.Info" Icon="Icons.Material.Filled.Lightbulb" Class="mb-4">
                                        Adjust your pricing to stay competitive. Consider recent market trends and tool condition.
                                    </MudAlert>
                                </MudItem>
                                
                                <MudItem xs="12" sm="4">
                                    <MudNumericField @bind-Value="updateToolRequest.DailyRate"
                                                     Label="Daily Rate"
                                                     Variant="Variant.Outlined"
                                                     FullWidth="true"
                                                     Required="true"
                                                     RequiredError="Daily rate is required"
                                                     Adornment="Adornment.Start"
                                                     AdornmentText="$"
                                                     Min="0.01m"
                                                     Step="0.01m"
                                                     Format="F2"
                                                     Class="mb-4" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="4">
                                    <MudNumericField @bind-Value="updateToolRequest.WeeklyRate"
                                                     Label="Weekly Rate (Optional)"
                                                     Variant="Variant.Outlined"
                                                     FullWidth="true"
                                                     Adornment="Adornment.Start"
                                                     AdornmentText="$"
                                                     Min="0m"
                                                     Step="0.01m"
                                                     Format="F2"
                                                     Class="mb-4" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="4">
                                    <MudNumericField @bind-Value="updateToolRequest.MonthlyRate"
                                                     Label="Monthly Rate (Optional)"
                                                     Variant="Variant.Outlined"
                                                     FullWidth="true"
                                                     Adornment="Adornment.Start"
                                                     AdornmentText="$"
                                                     Min="0m"
                                                     Step="0.01m"
                                                     Format="F2"
                                                     Class="mb-4" />
                                </MudItem>
                                
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="updateToolRequest.DepositRequired"
                                                     Label="Security Deposit"
                                                     Variant="Variant.Outlined"
                                                     FullWidth="true"
                                                     Required="true"
                                                     RequiredError="Deposit amount is required"
                                                     Adornment="Adornment.Start"
                                                     AdornmentText="$"
                                                     Min="0m"
                                                     Step="0.01m"
                                                     Format="F2"
                                                     HelperText="Refundable deposit to cover potential damages"
                                                     Class="mb-4" />
                                </MudItem>
                            </MudGrid>
                        </div>
                    </MudTabPanel>

                    <!-- Images Tab -->
                    <MudTabPanel Text="Photos" Icon="Icons.Material.Filled.PhotoCamera">
                        <div class="pa-4">
                            <MudAlert Severity="Severity.Info" Icon="Icons.Material.Filled.PhotoCamera" Class="mb-4">
                                Update your photos to show the current condition of your tool. Fresh photos can increase rental requests!
                            </MudAlert>
                            
                            <!-- Current Images -->
                            @if (updateToolRequest.ImageUrls.Any())
                            {
                                <MudText Typo="Typo.h6" Class="mb-3">Current Photos</MudText>
                                <div class="d-flex flex-wrap gap-4 mb-4">
                                    @foreach (var imageUrl in updateToolRequest.ImageUrls)
                                    {
                                        <MudPaper Class="pa-2" Style="border-radius: 8px;">
                                            <img src="@imageUrl" alt="Tool image" style="width: 120px; height: 120px; object-fit: cover; border-radius: 4px;" />
                                        </MudPaper>
                                    }
                                </div>
                            }
                            
                            <!-- Image Upload Area -->
                            <MudPaper Class="pa-8 text-center mb-4" Elevation="2" Style="border: 2px dashed var(--mud-palette-primary); border-radius: 12px;">
                                <MudIcon Icon="Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                                <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">Upload New Photos</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                                    Drag and drop images here, or click to browse
                                </MudText>
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload">
                                    Choose Files
                                </MudButton>
                            </MudPaper>
                        </div>
                    </MudTabPanel>
                </MudTabs>

                <!-- Action Buttons -->
                <div class="d-flex justify-space-between align-center mt-6">
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Secondary" 
                               Size="Size.Large"
                               OnClick="Cancel"
                               StartIcon="Icons.Material.Filled.Cancel">
                        Cancel
                    </MudButton>
                    
                    <div class="d-flex gap-3">
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Warning" 
                                   Size="Size.Large"
                                   OnClick="ViewTool"
                                   StartIcon="Icons.Material.Filled.Visibility">
                            View Tool
                        </MudButton>

                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Size="Size.Large"
                                   Disabled="isSubmitting"
                                   StartIcon="@(isSubmitting ? null : Icons.Material.Filled.Save)">
                            @if (isSubmitting)
                            {
                                <MudProgressCircular Color="Color.Secondary" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ml-2">Updating Tool...</MudText>
                            }
                            else
                            {
                                <MudText>Update Tool</MudText>
                            }
                        </MudButton>
                    </div>
                </div>
            </EditForm>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public string Id { get; set; } = string.Empty;
    
    private UpdateToolRequest updateToolRequest = new();
    private string errorMessage = string.Empty;
    private string submitErrorMessage = string.Empty;
    private bool isLoading = true;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadToolForEdit();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(Id))
        {
            await LoadToolForEdit();
        }
    }

    private async Task LoadToolForEdit()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var result = await ToolService.GetToolAsync(Id);
            
            if (result.Success && result.Data != null)
            {
                var tool = result.Data;
                
                // Map tool data to update request
                updateToolRequest = new UpdateToolRequest
                {
                    Name = tool.Name ?? string.Empty,
                    Description = tool.Description ?? string.Empty,
                    Category = tool.Category ?? string.Empty,
                    Brand = tool.Brand ?? string.Empty,
                    Model = tool.Model ?? string.Empty,
                    DailyRate = tool.DailyRate,
                    WeeklyRate = tool.WeeklyRate,
                    MonthlyRate = tool.MonthlyRate,
                    DepositRequired = tool.DepositRequired,
                    Condition = tool.Condition ?? string.Empty,
                    Location = tool.Location ?? string.Empty,
                    IsAvailable = tool.IsAvailable,
                    ImageUrls = tool.ImageUrls?.ToList() ?? new List<string>()
                };
            }
            else
            {
                errorMessage = result.Message ?? "Tool not found or you don't have permission to edit it.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred while loading the tool: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleUpdateTool()
    {
        isSubmitting = true;
        submitErrorMessage = string.Empty;

        try
        {
            var result = await ToolService.UpdateToolAsync(Id, updateToolRequest);
            
            if (result.Success)
            {
                Snackbar.Add("Tool updated successfully!", Severity.Success);
                Navigation.NavigateTo("/my-tools");
            }
            else
            {
                submitErrorMessage = result.Message ?? "Failed to update tool.";
            }
        }
        catch (Exception ex)
        {
            submitErrorMessage = $"An error occurred while updating the tool: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/my-tools");
    }

    private void ViewTool()
    {
        Navigation.NavigateTo($"/tools/{Id}");
    }
}