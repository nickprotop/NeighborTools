@page "/profile"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Profile - NeighborTools</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <!-- Header -->
    <div class="d-flex flex-column align-center mb-6">
        <MudAvatar Size="Size.Large" Color="Color.Primary" Class="mb-4" Style="width: 120px; height: 120px; font-size: 3rem;">
            @if (!string.IsNullOrEmpty(userProfile.AvatarUrl))
            {
                <MudImage Src="@userProfile.AvatarUrl" Alt="Profile Picture" />
            }
            else
            {
                <MudText>@GetInitials()</MudText>
            }
        </MudAvatar>
        
        <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">
            @userProfile.FirstName @userProfile.LastName
        </MudText>
        
        <div class="d-flex align-center gap-2 mb-2">
            <MudIcon Icon="Icons.Material.Filled.LocationOn" Color="Color.Secondary" Size="Size.Small" />
            <MudText Typo="Typo.body1" Color="Color.Secondary">@userProfile.Location</MudText>
        </div>
        
        <div class="d-flex align-center gap-4 mb-4">
            <div class="d-flex align-center gap-1">
                <MudRating ReadOnly="true" SelectedValue="@userProfile.Rating" MaxValue="5" Size="Size.Small" />
                <MudText Typo="Typo.body2">(@userProfile.ReviewCount reviews)</MudText>
            </div>
            <MudChip T="string" Color="@(userProfile.IsVerified ? Color.Success : Color.Warning)" Size="Size.Small" Icon="@(userProfile.IsVerified ? Icons.Material.Filled.Verified : Icons.Material.Filled.Warning)">
                @(userProfile.IsVerified ? "Verified" : "Unverified")
            </MudChip>
        </div>
        
        <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center" Class="mb-4" Style="max-width: 600px;">
            @userProfile.Bio
        </MudText>
    </div>

    <MudTabs Elevation="4" Rounded="true" Color="Color.Primary">
        <!-- Personal Information Tab -->
        <MudTabPanel Text="Personal Info" Icon="Icons.Material.Filled.Person">
            <div class="pa-6">
                <MudGrid>
                    <MudItem xs="12" md="8">
                        <EditForm Model="userProfile" OnValidSubmit="SaveProfile">
                            <DataAnnotationsValidator />
                            
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="userProfile.FirstName"
                                                  Label="First Name"
                                                  Variant="Variant.Outlined"
                                                  FullWidth="true"
                                                  Required="true"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.Person" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="userProfile.LastName"
                                                  Label="Last Name"
                                                  Variant="Variant.Outlined"
                                                  FullWidth="true"
                                                  Required="true"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.Person" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="userProfile.Email"
                                                  Label="Email Address"
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Email"
                                                  FullWidth="true"
                                                  Disabled="true"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.Email"
                                                  HelperText="Email cannot be changed. Contact support if needed." />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="userProfile.PhoneNumber"
                                                  Label="Phone Number"
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Telephone"
                                                  FullWidth="true"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.Phone" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="userProfile.Location"
                                                  Label="Location"
                                                  Variant="Variant.Outlined"
                                                  FullWidth="true"
                                                  Required="true"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.LocationOn" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="userProfile.Bio"
                                                  Label="Bio"
                                                  Variant="Variant.Outlined"
                                                  Lines="4"
                                                  FullWidth="true"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="Icons.Material.Filled.Description"
                                                  HelperText="Tell others about yourself and your tool-sharing philosophy" />
                                </MudItem>
                            </MudGrid>
                            
                            <div class="d-flex justify-end gap-4 mt-6">
                                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ResetForm" StartIcon="Icons.Material.Filled.Refresh">
                                    Reset
                                </MudButton>
                                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Disabled="isLoading" StartIcon="@(isLoading ? null : Icons.Material.Filled.Save)">
                                    @if (isLoading)
                                    {
                                        <MudProgressCircular Color="Color.Secondary" Size="Size.Small" Indeterminate="true" />
                                        <MudText Class="ml-2">Saving...</MudText>
                                    }
                                    else
                                    {
                                        <MudText>Save Changes</MudText>
                                    }
                                </MudButton>
                            </div>
                        </EditForm>
                    </MudItem>
                    
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                            <MudText Typo="Typo.h6" Class="mb-3" Color="Color.Primary">
                                <MudIcon Icon="Icons.Material.Filled.PhotoCamera" Class="mr-2" />
                                Profile Picture
                            </MudText>
                            
                            <div class="text-center mb-4">
                                <MudAvatar Size="Size.Large" Color="Color.Primary" Style="width: 100px; height: 100px; font-size: 2rem;">
                                    @if (!string.IsNullOrEmpty(userProfile.AvatarUrl))
                                    {
                                        <MudImage Src="@userProfile.AvatarUrl" Alt="Profile Picture" />
                                    }
                                    else
                                    {
                                        <MudText>@GetInitials()</MudText>
                                    }
                                </MudAvatar>
                            </div>
                            
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" StartIcon="Icons.Material.Filled.Upload">
                                Upload New Photo
                            </MudButton>
                            
                            @if (!string.IsNullOrEmpty(userProfile.AvatarUrl))
                            {
                                <MudButton Variant="Variant.Text" Color="Color.Error" FullWidth="true" StartIcon="Icons.Material.Filled.Delete" Class="mt-2">
                                    Remove Photo
                                </MudButton>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </div>
        </MudTabPanel>

        <!-- Statistics Tab -->
        <MudTabPanel Text="Statistics" Icon="Icons.Material.Filled.Analytics">
            <div class="pa-6">
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="4" Style="border-radius: 12px;">
                            <MudCardContent Class="text-center">
                                <MudIcon Icon="Icons.Material.Filled.Build" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                                <MudText Typo="Typo.h4" Color="Color.Primary">12</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Tools Shared</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="4" Style="border-radius: 12px;">
                            <MudCardContent Class="text-center">
                                <MudIcon Icon="Icons.Material.Filled.CalendarToday" Size="Size.Large" Color="Color.Success" Class="mb-2" />
                                <MudText Typo="Typo.h4" Color="Color.Success">28</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Successful Rentals</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="4" Style="border-radius: 12px;">
                            <MudCardContent Class="text-center">
                                <MudIcon Icon="Icons.Material.Filled.AttachMoney" Size="Size.Large" Color="Color.Info" Class="mb-2" />
                                <MudText Typo="Typo.h4" Color="Color.Info">$1,245</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Total Earned</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="4" Style="border-radius: 12px;">
                            <MudCardContent Class="text-center">
                                <MudIcon Icon="Icons.Material.Filled.Star" Size="Size.Large" Color="Color.Warning" Class="mb-2" />
                                <MudText Typo="Typo.h4" Color="Color.Warning">4.8</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Average Rating</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
                
                <MudDivider Class="my-6" />
                
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-4">Recent Activity</MudText>
                
                <MudTimeline TimelineOrientation="TimelineOrientation.Vertical">
                    <MudTimelineItem Color="Color.Success" Size="Size.Small">
                        <ItemContent>
                            <div class="d-flex justify-space-between align-center">
                                <div>
                                    <MudText Typo="Typo.body1">Received 5-star review</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">For renting out Circular Saw</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">2 days ago</MudText>
                            </div>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Info" Size="Size.Small">
                        <ItemContent>
                            <div class="d-flex justify-space-between align-center">
                                <div>
                                    <MudText Typo="Typo.body1">Added new tool</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Pressure Washer</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">1 week ago</MudText>
                            </div>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Primary" Size="Size.Small">
                        <ItemContent>
                            <div class="d-flex justify-space-between align-center">
                                <div>
                                    <MudText Typo="Typo.body1">Completed rental</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Rented Lawn Mower from John</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">2 weeks ago</MudText>
                            </div>
                        </ItemContent>
                    </MudTimelineItem>
                </MudTimeline>
            </div>
        </MudTabPanel>

        <!-- Reviews Tab -->
        <MudTabPanel Text="Reviews" Icon="Icons.Material.Filled.Star">
            <div class="pa-6">
                <div class="d-flex justify-space-between align-center mb-6">
                    <MudText Typo="Typo.h5" Color="Color.Primary">Reviews & Ratings</MudText>
                    <div class="d-flex align-center gap-2">
                        <MudRating ReadOnly="true" SelectedValue="@userProfile.Rating" MaxValue="5" />
                        <MudText Typo="Typo.h6">@userProfile.Rating/5</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">(@userProfile.ReviewCount reviews)</MudText>
                    </div>
                </div>
                
                <!-- Mock Reviews -->
                @foreach (var review in GetMockReviews())
                {
                    <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px;">
                        <MudCardContent>
                            <div class="d-flex justify-space-between align-start mb-3">
                                <div class="d-flex align-center gap-3">
                                    <MudAvatar Color="Color.Secondary" Size="Size.Medium">
                                        @review.ReviewerName.Substring(0, 1)
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.body1">@review.ReviewerName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@review.Date.ToString("MMM dd, yyyy")</MudText>
                                    </div>
                                </div>
                                <MudRating ReadOnly="true" SelectedValue="@review.Rating" MaxValue="5" Size="Size.Small" />
                            </div>
                            <MudText Typo="Typo.body2" Class="mb-2">@review.Comment</MudText>
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">@review.ToolName</MudChip>
                        </MudCardContent>
                    </MudCard>
                }
            </div>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private UserProfile userProfile = new();
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserProfile();
    }

    private async Task LoadUserProfile()
    {
        // Mock user data - in real app, load from API
        userProfile = new UserProfile
        {
            FirstName = "John",
            LastName = "Smith",
            Email = "john.smith@example.com",
            PhoneNumber = "+1 (555) 123-4567",
            Location = "San Francisco, CA",
            Bio = "Passionate DIY enthusiast who loves sharing tools and helping neighbors with their projects. I believe in building stronger communities through collaboration and resource sharing.",
            AvatarUrl = "",
            Rating = 5,
            ReviewCount = 24,
            IsVerified = true
        };
    }

    private string GetInitials()
    {
        return $"{userProfile.FirstName?.FirstOrDefault()}{userProfile.LastName?.FirstOrDefault()}";
    }

    private async Task SaveProfile()
    {
        isLoading = true;
        
        try
        {
            // Simulate API call
            await Task.Delay(2000);
            Snackbar.Add("Profile updated successfully!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to update profile. Please try again.", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ResetForm()
    {
        // Reload original data
        LoadUserProfile();
    }

    private List<ReviewInfo> GetMockReviews()
    {
        return new List<ReviewInfo>
        {
            new ReviewInfo
            {
                ReviewerName = "Alice Johnson",
                Rating = 5,
                Comment = "John was very responsive and the drill was in excellent condition. Highly recommended!",
                ToolName = "Cordless Drill",
                Date = DateTime.Now.AddDays(-5)
            },
            new ReviewInfo
            {
                ReviewerName = "Mike Wilson",
                Rating = 4,
                Comment = "Great experience renting the saw. John provided clear instructions and was flexible with pickup.",
                ToolName = "Circular Saw",
                Date = DateTime.Now.AddDays(-12)
            },
            new ReviewInfo
            {
                ReviewerName = "Sarah Brown",
                Rating = 5,
                Comment = "Perfect condition tool and great communication. Will definitely rent from John again!",
                ToolName = "Pressure Washer",
                Date = DateTime.Now.AddDays(-20)
            }
        };
    }

    public class UserProfile
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public string Location { get; set; } = string.Empty;
        public string Bio { get; set; } = string.Empty;
        public string AvatarUrl { get; set; } = string.Empty;
        public int Rating { get; set; }
        public int ReviewCount { get; set; }
        public bool IsVerified { get; set; }
    }

    public class ReviewInfo
    {
        public string ReviewerName { get; set; } = string.Empty;
        public int Rating { get; set; }
        public string Comment { get; set; } = string.Empty;
        public string ToolName { get; set; } = string.Empty;
        public DateTime Date { get; set; }
    }
}