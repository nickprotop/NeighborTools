@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using frontend.Models
@using frontend.Services
@inject IToolService ToolService
@attribute [AllowAnonymous]

<PageTitle>NeighborTools - Share and Borrow Tools</PageTitle>

<!-- Overdue Rental Alerts -->
<OverdueRentalAlertComponent ShowDetails="true" 
                           ShowActions="true" 
                           ShowOverdueProgress="true"
                           AutoRefresh="true" 
                           Class="mb-4" />

<!-- Modern Hero Section -->
<MudPaper Elevation="0" Class="pa-8 mb-8 animate-fade-in-up" Style="background: var(--mud-gradient-hero); border-radius: var(--mud-radius-2xl); box-shadow: var(--mud-shadow-lg);">
    <div class="d-flex flex-column align-center text-center">
        <MudIcon Icon="@Icons.Material.Filled.Handyman" Size="Size.Large" Class="animate-float" Style="font-size: 5rem; color: white; margin-bottom: var(--mud-spacing-lg);" />
        <MudText Typo="Typo.h2" Style="color: white; font-weight: var(--mud-font-weight-bold); font-family: var(--mud-font-family-sans); line-height: var(--mud-line-height-tight);" GutterBottom="true">
            Welcome to NeighborTools
        </MudText>
        <MudText Typo="Typo.h6" Style="color: rgba(255,255,255,0.9); max-width: 600px; margin-bottom: var(--mud-spacing-2xl); font-family: var(--mud-font-family-sans); line-height: var(--mud-line-height-relaxed);">
            Share tools with your neighbors and borrow what you need. Building community one tool at a time.
        </MudText>
        <AuthorizeView>
            <Authorized>
                <MudText Typo="Typo.h6" Style="color: white; margin-bottom: var(--mud-spacing-xl); font-family: var(--mud-font-family-sans);">
                    Welcome back, @context.User.Identity?.Name! 👋
                </MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Surface"
                           Size="Size.Large"
                           Href="/tools"
                           StartIcon="@Icons.Material.Filled.Search"
                           Class="animate-glow"
                           Style="color: var(--mud-palette-primary); font-weight: var(--mud-font-weight-bold); font-family: var(--mud-font-family-sans); border-radius: var(--mud-radius-full); padding: var(--mud-spacing-lg) var(--mud-spacing-2xl);">
                    Browse Tools
                </MudButton>
            </Authorized>
        </AuthorizeView>
    </div>
</MudPaper>

<!-- Modern Quick Actions -->
<MudGrid Class="mb-8">
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="0" Class="modern-card animate-fade-in-up animate-delay-100" Style="height: 100%;">
            <MudCardContent Class="d-flex flex-column align-center text-center pa-6">
                <MudIcon Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Large" Class="mb-4 animate-pulse" Style="font-size: 3.5rem;" />
                <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-semibold);">Share Your Tools</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4" Style="font-family: var(--mud-font-family-sans); line-height: var(--mud-line-height-relaxed);">
                    List your tools and earn money by sharing them with neighbors.
                </MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/my-tools" StartIcon="@Icons.Material.Filled.Inventory" Style="border-radius: var(--mud-radius-full); font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-medium);">
                    My Tools
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="0" Class="modern-card animate-fade-in-up animate-delay-200" Style="height: 100%;">
            <MudCardContent Class="d-flex flex-column align-center text-center pa-6">
                <MudIcon Icon="@Icons.Material.Filled.Search" Color="Color.Success" Size="Size.Large" Class="mb-4 animate-pulse" Style="font-size: 3.5rem;" />
                <MudText Typo="Typo.h5" Color="Color.Success" GutterBottom="true" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-semibold);">Find Tools</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4" Style="font-family: var(--mud-font-family-sans); line-height: var(--mud-line-height-relaxed);">
                    Browse and rent tools from your neighbors when you need them.
                </MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Success" Href="/tools" StartIcon="@Icons.Material.Filled.Search" Style="border-radius: var(--mud-radius-full); font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-medium);">
                    Browse Tools
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="0" Class="modern-card animate-fade-in-up animate-delay-300" Style="height: 100%;">
            <MudCardContent Class="d-flex flex-column align-center text-center pa-6">
                <MudIcon Icon="@Icons.Material.Filled.Groups" Color="Color.Info" Size="Size.Large" Class="mb-4 animate-pulse" Style="font-size: 3.5rem;" />
                <MudText Typo="Typo.h5" Color="Color.Info" GutterBottom="true" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-semibold);">Build Community</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4" Style="font-family: var(--mud-font-family-sans); line-height: var(--mud-line-height-relaxed);">
                    Connect with neighbors and build stronger community relationships.
                </MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Info" Href="/profile" StartIcon="@Icons.Material.Filled.Person" Style="border-radius: var(--mud-radius-full); font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-medium);">
                    Your Profile
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<!-- Featured Tools Section -->
@if (isLoading)
{
    <MudPaper Class="pa-8 text-center animate-fade-in-scale" Elevation="0" Style="border-radius: var(--mud-radius-xl); background: var(--mud-palette-surface-container-low);">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
        <MudText Typo="Typo.h6" Class="mt-4" Style="font-family: var(--mud-font-family-sans); color: var(--mud-text-secondary);">Loading featured tools...</MudText>
    </MudPaper>
}
else if (featuredTools != null && featuredTools.Any())
{
    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true" Class="mb-6 animate-fade-in-up" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-bold);">
        <MudIcon Icon="@Icons.Material.Filled.Star" Class="mr-2" />
        Featured Tools
    </MudText>
    
    <MudGrid>
        @foreach (var tool in featuredTools.Take(6))
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="0" Class="modern-card hover-card animate-fade-in-up" Style="height: 100%;">
                    @if (tool.ImageUrls.Any())
                    {
                        <MudCardMedia Image="@tool.ImageUrls.First()" Height="200" Style="border-radius: var(--mud-radius-xl) var(--mud-radius-xl) 0 0;" />
                    }
                    else
                    {
                        <div class="d-flex align-center justify-center" style="height: 200px; background: var(--mud-palette-surface-variant); border-radius: var(--mud-radius-xl) var(--mud-radius-xl) 0 0;">
                            <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Large" Color="Color.Secondary" Style="font-size: 3rem;" />
                        </div>
                    }
                    
                    <MudCardContent>
                        <MudText Typo="Typo.h6" GutterBottom="true" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-semibold);">@tool.Name</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3" Style="font-family: var(--mud-font-family-sans); line-height: var(--mud-line-height-relaxed);">
                            @(tool.Description.Length > 100 ? tool.Description.Substring(0, 100) + "..." : tool.Description)
                        </MudText>
                        
                        <div class="d-flex justify-space-between align-center mb-3">
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-medium);">@tool.Category</MudChip>
                            <MudChip T="string" Color="@(tool.IsAvailable ? Color.Success : Color.Error)" Size="Size.Small" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-medium);">
                                @(tool.IsAvailable ? "Available" : "Unavailable")
                            </MudChip>
                        </div>
                        
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-bold);">
                            $@tool.DailyRate.ToString("F2") / day
                        </MudText>
                        
                        @if (tool.Rating.HasValue)
                        {
                            <div class="d-flex align-center mb-3">
                                <MudRating ReadOnly="true" SelectedValue="@((int)tool.Rating.Value)" MaxValue="5" Size="Size.Small" />
                                <MudText Typo="Typo.caption" Class="ml-2" Style="font-family: var(--mud-font-family-sans);">(@tool.ReviewCount reviews)</MudText>
                            </div>
                        }
                    </MudCardContent>
                    
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   FullWidth="true"
                                   Href="/tools"
                                   Disabled="@(!tool.IsAvailable)"
                                   StartIcon="@Icons.Material.Filled.Visibility"
                                   Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-medium); border-radius: var(--mud-radius-lg);">
                            @(tool.IsAvailable ? "View Details" : "Unavailable")
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
    
    <div class="d-flex justify-center mt-6">
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Primary" 
                   Size="Size.Large"
                   Href="/tools"
                   StartIcon="@Icons.Material.Filled.ViewList"
                   Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-medium); border-radius: var(--mud-radius-full); padding: var(--mud-spacing-lg) var(--mud-spacing-2xl);">
            View All Tools
        </MudButton>
    </div>
}
else
{
    <MudPaper Class="pa-8 text-center animate-fade-in-scale" Elevation="0" Style="border-radius: var(--mud-radius-xl); background: var(--mud-palette-surface-container-low);">
        <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" Class="mb-4" />
        <MudText Typo="Typo.h6" Color="Color.Secondary" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-semibold);">No tools available yet</MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4" Style="font-family: var(--mud-font-family-sans); line-height: var(--mud-line-height-relaxed);">
            Be the first to share a tool with your community!
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/tools/create" StartIcon="@Icons.Material.Filled.Add" Style="font-family: var(--mud-font-family-sans); font-weight: var(--mud-font-weight-medium); border-radius: var(--mud-radius-full);">
            Add Your First Tool
        </MudButton>
    </MudPaper>
}

<style>
    .hover-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--mud-shadow-xl);
        border-color: var(--mud-border-focus);
    }
</style>

@code {
    private List<Tool>? featuredTools;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadFeaturedTools();
    }

    private async Task LoadFeaturedTools()
    {
        isLoading = true;

        try
        {
            var result = await ToolService.GetToolsAsync();
            
            if (result.Success)
            {
                featuredTools = result.Data?.Where(t => t.IsAvailable).ToList();
            }
        }
        catch (Exception)
        {
            // Silently handle errors for featured tools
        }
        finally
        {
            isLoading = false;
        }
    }
}
