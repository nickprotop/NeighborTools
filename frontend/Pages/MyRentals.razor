@page "/my-rentals"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using frontend.Models
@using frontend.Services
@using frontend.Components
@inject IRentalService RentalService
@inject IPaymentService PaymentService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@attribute [Authorize]

<PageTitle>My Rentals - NeighborTools</PageTitle>

<!-- Overdue Rental Alerts -->
<OverdueRentalAlertComponent ShowDetails="true" 
                           ShowActions="true" 
                           ShowOverdueProgress="true"
                           AutoRefresh="true" 
                           Class="mb-4" />

<!-- Header Section -->
<div class="d-flex flex-column flex-sm-row justify-space-between align-center mb-6 gap-4">
    <div>
        <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="mr-2" />
            My Rentals
        </MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary">
            Track your rental requests and manage your tool rentals
        </MudText>
    </div>
</div>

<!-- Tabs for different rental types -->
<MudTabs Elevation="4" Rounded="true" PanelClass="pa-6" @bind-ActivePanelIndex="activeTab">
    <MudTabPanel Text="My Requests" Icon="@Icons.Material.Filled.ShoppingCart">
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h6">Tools I'm Renting</MudText>
            <MudSelect T="string" @bind-Value="selectedRenterStatus" Label="Status Filter" Variant="Variant.Outlined" Dense="true" Style="min-width: 150px;">
                <MudSelectItem T="string" Value="@string.Empty">All Status</MudSelectItem>
                <MudSelectItem T="string" Value="@("Pending")">Pending</MudSelectItem>
                <MudSelectItem T="string" Value="@("Approved")">Approved</MudSelectItem>
                <MudSelectItem T="string" Value="@("PickedUp")">Picked Up</MudSelectItem>
                <MudSelectItem T="string" Value="@("Returned")">Returned</MudSelectItem>
                <MudSelectItem T="string" Value="@("Rejected")">Rejected</MudSelectItem>
                <MudSelectItem T="string" Value="@("Cancelled")">Cancelled</MudSelectItem>
            </MudSelect>
        </div>
        
        @if (isLoadingRenterRentals)
        {
            <div class="text-center pa-8">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.h6" Class="mt-4">Loading rental requests...</MudText>
            </div>
        }
        else if (renterRentals?.Any() == true)
        {
            <MudGrid>
                @foreach (var rental in GetFilteredRenterRentals())
                {
                    <MudItem xs="12" md="6" lg="4">
                        <MudCard Elevation="4" Style="height: 100%; border-radius: 12px;">
                            @if (rental.Tool?.ImageUrls.Any() == true)
                            {
                                <MudCardMedia Image="@rental.Tool.ImageUrls.First()" Height="200" Style="border-radius: 12px 12px 0 0;" />
                            }
                            else
                            {
                                <div class="d-flex align-center justify-center" style="height: 200px; background: var(--mud-palette-surface-variant); border-radius: 12px 12px 0 0;">
                                    <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Large" Color="Color.Secondary" />
                                </div>
                            }
                            
                            <MudCardContent>
                                <MudText Typo="Typo.h6" GutterBottom="true">@rental.ToolName</MudText>
                                
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudChip T="string" Color="@GetStatusColor(rental.Status)" Size="Size.Small">
                                        @rental.Status
                                    </MudChip>
                                    <MudText Typo="Typo.h6" Color="Color.Primary">
                                        $@rental.TotalCost.ToString("F2")
                                    </MudText>
                                </div>
                                
                                @if (rental.Status == "Approved" && !rental.IsPaid)
                                {
                                    <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">
                                        <MudText Typo="Typo.caption">
                                            <MudIcon Icon="@Icons.Material.Filled.Payment" Size="Size.Small" /> Payment Required
                                        </MudText>
                                    </MudAlert>
                                }
                                
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    <strong>Owner:</strong> 
                                    <UserLink UserId="@rental.OwnerId" 
                                              DisplayName="@rental.OwnerName" 
                                              ShowAsLink="true" 
                                              ShowAvatar="false" />
                                </MudText>
                                
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    <strong>Period:</strong> @rental.StartDate.ToString("MMM dd") - @rental.EndDate.ToString("MMM dd, yyyy")
                                </MudText>
                                
                                @if (rental.DepositAmount > 0)
                                {
                                    <MudText Typo="Typo.body2" Class="mb-2">
                                        <strong>Deposit:</strong> $@rental.DepositAmount.ToString("F2")
                                    </MudText>
                                }
                                
                                @if (!string.IsNullOrEmpty(rental.Notes))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                        <strong>Notes:</strong> @rental.Notes
                                    </MudText>
                                }
                                
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Requested: @rental.CreatedAt.ToString("MMM dd, yyyy")
                                </MudText>
                            </MudCardContent>
                            
                            <MudCardActions Class="pa-4">
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => ViewRentalDetails(rental.Id)" StartIcon="@Icons.Material.Filled.Visibility">
                                    View Details
                                </MudButton>
                                @if (rental.Status == "Approved" && !rental.IsPaid)
                                {
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="() => InitiatePayment(rental.Id)" StartIcon="@Icons.Material.Filled.Payment">
                                        Pay Now
                                    </MudButton>
                                }
                                else if (rental.Status == "Pending")
                                {
                                    <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="() => CancelRental(rental.Id)" StartIcon="@Icons.Material.Filled.Cancel">
                                        Cancel
                                    </MudButton>
                                }
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <MudPaper Class="pa-8 text-center" Elevation="2" Style="border-radius: 12px;">
                <MudIcon Icon="@Icons.Material.Filled.ShoppingCartCheckout" Size="Size.Large" Color="Color.Secondary" Class="mb-4" />
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">No rental requests found</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                    You haven't made any rental requests yet. Browse tools to get started!
                </MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/tools" StartIcon="@Icons.Material.Filled.Search">
                    Browse Tools
                </MudButton>
            </MudPaper>
        }
    </MudTabPanel>

    <MudTabPanel Text="Tool Rentals" Icon="@Icons.Material.Filled.Build">
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h6">My Tools Being Rented</MudText>
            <MudSelect T="string" @bind-Value="selectedOwnerStatus" Label="Status Filter" Variant="Variant.Outlined" Dense="true" Style="min-width: 150px;">
                <MudSelectItem T="string" Value="@string.Empty">All Status</MudSelectItem>
                <MudSelectItem T="string" Value="@("Pending")">Pending</MudSelectItem>
                <MudSelectItem T="string" Value="@("Approved")">Approved</MudSelectItem>
                <MudSelectItem T="string" Value="@("PickedUp")">Picked Up</MudSelectItem>
                <MudSelectItem T="string" Value="@("Returned")">Returned</MudSelectItem>
                <MudSelectItem T="string" Value="@("Rejected")">Rejected</MudSelectItem>
            </MudSelect>
        </div>
        
        @if (isLoadingOwnerRentals)
        {
            <div class="text-center pa-8">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.h6" Class="mt-4">Loading tool rentals...</MudText>
            </div>
        }
        else if (ownerRentals?.Any() == true)
        {
            <MudGrid>
                @foreach (var rental in GetFilteredOwnerRentals())
                {
                    <MudItem xs="12" md="6" lg="4">
                        <MudCard Elevation="4" Style="height: 100%; border-radius: 12px;">
                            @if (rental.Tool?.ImageUrls.Any() == true)
                            {
                                <MudCardMedia Image="@rental.Tool.ImageUrls.First()" Height="200" Style="border-radius: 12px 12px 0 0;" />
                            }
                            else
                            {
                                <div class="d-flex align-center justify-center" style="height: 200px; background: var(--mud-palette-surface-variant); border-radius: 12px 12px 0 0;">
                                    <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Large" Color="Color.Secondary" />
                                </div>
                            }
                            
                            <MudCardContent>
                                <MudText Typo="Typo.h6" GutterBottom="true">@rental.ToolName</MudText>
                                
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudChip T="string" Color="@GetStatusColor(rental.Status)" Size="Size.Small">
                                        @rental.Status
                                    </MudChip>
                                    <MudText Typo="Typo.h6" Color="Color.Primary">
                                        $@rental.TotalCost.ToString("F2")
                                    </MudText>
                                </div>
                                
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    <strong>Renter:</strong> 
                                    <UserLink UserId="@rental.RenterId" 
                                              DisplayName="@rental.RenterName" 
                                              ShowAsLink="true" 
                                              ShowAvatar="false" />
                                </MudText>
                                
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    <strong>Period:</strong> @rental.StartDate.ToString("MMM dd") - @rental.EndDate.ToString("MMM dd, yyyy")
                                </MudText>
                                
                                @if (!string.IsNullOrEmpty(rental.Notes))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                        <strong>Notes:</strong> @rental.Notes
                                    </MudText>
                                }
                                
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Requested: @rental.CreatedAt.ToString("MMM dd, yyyy")
                                </MudText>
                            </MudCardContent>
                            
                            <MudCardActions Class="pa-4">
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => ViewRentalDetails(rental.Id)" StartIcon="@Icons.Material.Filled.Visibility">
                                    View Details
                                </MudButton>
                                @if (rental.Status == "Pending")
                                {
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" OnClick="() => ApproveRental(rental.Id)" StartIcon="@Icons.Material.Filled.CheckCircle">
                                        Approve
                                    </MudButton>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="() => RejectRental(rental.Id)" StartIcon="@Icons.Material.Filled.Cancel">
                                        Reject
                                    </MudButton>
                                }
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <MudPaper Class="pa-8 text-center" Elevation="2" Style="border-radius: 12px;">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Color="Color.Secondary" Class="mb-4" />
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">No rental requests for your tools</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                    Share your tools to start receiving rental requests!
                </MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/tools/create" StartIcon="@Icons.Material.Filled.Add">
                    Add Tool
                </MudButton>
            </MudPaper>
        }
    </MudTabPanel>
</MudTabs>

@code {
    private List<Rental>? renterRentals;
    private List<Rental>? ownerRentals;
    private bool isLoadingRenterRentals = true;
    private bool isLoadingOwnerRentals = true;
    private string selectedRenterStatus = string.Empty;
    private string selectedOwnerStatus = string.Empty;
    private int activeTab = 0;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(
            LoadRenterRentals(),
            LoadOwnerRentals()
        );
    }

    private async Task LoadRenterRentals()
    {
        isLoadingRenterRentals = true;
        try
        {
            var result = await RentalService.GetMyRentalsAsync();
            if (result.Success)
            {
                renterRentals = result.Data;
            }
            else
            {
                Snackbar.Add($"Error loading rentals: {result.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading rentals: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingRenterRentals = false;
        }
    }

    private async Task LoadOwnerRentals()
    {
        isLoadingOwnerRentals = true;
        try
        {
            var result = await RentalService.GetMyToolRentalsAsync();
            if (result.Success)
            {
                ownerRentals = result.Data;
            }
            else
            {
                Snackbar.Add($"Error loading tool rentals: {result.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tool rentals: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingOwnerRentals = false;
        }
    }

    private List<Rental> GetFilteredRenterRentals()
    {
        if (renterRentals == null) return new List<Rental>();
        
        return string.IsNullOrEmpty(selectedRenterStatus) 
            ? renterRentals.ToList()
            : renterRentals.Where(r => r.Status == selectedRenterStatus).ToList();
    }

    private List<Rental> GetFilteredOwnerRentals()
    {
        if (ownerRentals == null) return new List<Rental>();
        
        return string.IsNullOrEmpty(selectedOwnerStatus) 
            ? ownerRentals.ToList()
            : ownerRentals.Where(r => r.Status == selectedOwnerStatus).ToList();
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Pending" => Color.Warning,
            "Approved" => Color.Info,
            "PickedUp" => Color.Primary,
            "Returned" => Color.Success,
            "Rejected" => Color.Error,
            "Cancelled" => Color.Secondary,
            "Overdue" => Color.Error,
            _ => Color.Default
        };
    }

    private void ViewRentalDetails(string rentalId)
    {
        Navigation.NavigateTo($"/rentals/{rentalId}");
    }

    private async Task ApproveRental(string rentalId)
    {
        try
        {
            var request = new RentalApprovalRequest { IsApproved = true };
            var result = await RentalService.ApproveRentalAsync(rentalId, request);
            
            if (result.Success)
            {
                Snackbar.Add("Rental approved successfully!", Severity.Success);
                await LoadOwnerRentals();
            }
            else
            {
                Snackbar.Add($"Error approving rental: {result.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error approving rental: {ex.Message}", Severity.Error);
        }
    }

    private async Task RejectRental(string rentalId)
    {
        try
        {
            var request = new RentalApprovalRequest { IsApproved = false, Reason = "Rejected by owner" };
            var result = await RentalService.RejectRentalAsync(rentalId, request);
            
            if (result.Success)
            {
                Snackbar.Add("Rental rejected.", Severity.Info);
                await LoadOwnerRentals();
            }
            else
            {
                Snackbar.Add($"Error rejecting rental: {result.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error rejecting rental: {ex.Message}", Severity.Error);
        }
    }

    private async Task InitiatePayment(string rentalId)
    {
        try
        {
            if (Guid.TryParse(rentalId, out var rentalGuid))
            {
                var result = await PaymentService.InitiatePaymentAsync(rentalGuid);
                
                if (result.Success && !string.IsNullOrEmpty(result.Data?.ApprovalUrl))
                {
                    Navigation.NavigateTo(result.Data.ApprovalUrl, true);
                }
                else
                {
                    Snackbar.Add(result.Message ?? "Failed to initiate payment", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("Invalid rental ID", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error initiating payment: {ex.Message}", Severity.Error);
        }
    }

    private void CancelRental(string rentalId)
    {
        Snackbar.Add("Cancel rental feature coming soon!", Severity.Info);
    }
}