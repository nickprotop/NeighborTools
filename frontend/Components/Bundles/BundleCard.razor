@using ToolsSharing.Frontend.Models
@using ToolsSharing.Frontend.Services
@inject IUrlService UrlService

<MudCard Class="bundle-card h-100" Style="cursor: pointer; transition: transform 0.2s ease-in-out;" 
         @onclick="OnClick">
    <MudCardMedia Image="@GetImageUrl()" Height="200" Class="bundle-image" />
    
    <MudCardContent Class="pa-4">
        <MudStack Spacing="2">
            <!-- Title and Category -->
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6" Class="bundle-title">@Bundle.Name</MudText>
                @if (Bundle.IsFeatured)
                {
                    <MudChip Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.Star" Text="Featured" T="string" />
                }
            </MudStack>

            <!-- Category and Skill Level -->
            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                <MudChip Size="Size.Small" Color="Color.Primary" Text="@Bundle.Category" T="string" />
                <MudChip Size="Size.Small" Color="Color.Secondary" Text="@Bundle.RequiredSkillLevel" T="string" />
            </MudStack>

            <!-- Description -->
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="bundle-description">
                @GetTruncatedDescription()
            </MudText>

            <!-- Tools Preview -->
            <MudStack Row Spacing="1" Class="mt-2">
                <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Color="Color.Primary" />
                <MudText Typo="Typo.caption" Color="Color.Primary">
                    @Bundle.Tools.Count tool@(Bundle.Tools.Count != 1 ? "s" : "") included
                </MudText>
            </MudStack>

            <!-- Stats -->
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-2">
                <MudStack Row Spacing="2">
                    <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Small" Color="Color.Secondary" />
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@Bundle.RentalCount rentals</MudText>
                    </MudStack>
                </MudStack>
                
                <!-- Duration -->
                <MudChip Size="Size.Small" 
                         Color="Color.Info" 
                         Text="@($"{Bundle.EstimatedProjectDuration}h project")" 
                         T="string" />
            </MudStack>

            <!-- Pricing -->
            <MudDivider />
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    @if (Bundle.BundleDiscount > 0)
                    {
                        <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2" 
                                   Style="text-decoration: line-through;" 
                                   Color="Color.Secondary">
                                $@Bundle.TotalCost.ToString("F2")/day
                            </MudText>
                            <MudChip Size="Size.Small" 
                                   Color="Color.Success" 
                                   Text="@($"-{Bundle.BundleDiscount:F0}%")" 
                                   T="string" />
                        </MudStack>
                    }
                    <MudText Typo="Typo.h6" Color="Color.Primary">
                        $@Bundle.DiscountedCost.ToString("F2")/day
                    </MudText>
                </div>
                
                <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@Bundle.OwnerName</MudText>
                </MudStack>
            </MudStack>

            <!-- Status Indicators -->
            <MudStack Spacing="2" Class="mt-2">
                <!-- Tool Approval Warning for Owners -->
                @if (ShowApprovalWarning && UnapprovedToolCount > 0)
                {
                    <MudStack Row Justify="Justify.Center">
                        <MudTooltip Text="@($"{UnapprovedToolCount} tool{(UnapprovedToolCount != 1 ? "s" : "")} in this bundle need approval")">
                            <MudChip Color="Color.Warning" 
                                   Size="Size.Small" 
                                   Icon="@Icons.Material.Filled.Warning" 
                                   Text="@($"{UnapprovedToolCount} Tool{(UnapprovedToolCount != 1 ? "s" : "")} Need Approval")" 
                                   T="string" />
                        </MudTooltip>
                    </MudStack>
                }
                
                <!-- Availability Indicator -->
                <MudStack Row Justify="Justify.Center">
                    @if (Bundle.IsAvailable)
                    {
                        <MudChip Color="Color.Success" 
                               Size="Size.Small" 
                               Icon="@Icons.Material.Filled.CheckCircle" 
                               Text="Available Now" 
                               T="string" />
                    }
                    else if (Bundle.AvailableFromDate.HasValue)
                    {
                        <MudChip Color="Color.Warning" 
                               Size="Size.Small" 
                               Icon="@Icons.Material.Filled.Schedule" 
                               Text="@($"Available {Bundle.AvailableFromDate.Value:MMM dd}")" 
                               T="string" />
                    }
                    else
                    {
                        <MudChip Color="Color.Error" 
                               Size="Size.Small" 
                               Icon="@Icons.Material.Filled.Block" 
                               Text="Currently Unavailable" 
                               T="string" />
                    }
                </MudStack>
            </MudStack>
        </MudStack>
    </MudCardContent>

    <!-- Hover Effect -->
    <style>
        .bundle-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .bundle-title {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            max-height: 2.6em;
        }

        .bundle-description {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
            max-height: 4.2em;
        }

        .bundle-image {
            background: linear-gradient(45deg, #f5f5f5 0%, #e0e0e0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
    </style>
</MudCard>

@code {
    [Parameter] public BundleModel Bundle { get; set; } = new();
    [Parameter] public EventCallback OnClick { get; set; }
    [Parameter] public bool ShowApprovalWarning { get; set; } = false;
    [Parameter] public int UnapprovedToolCount { get; set; } = 0;

    private string GetImageUrl()
    {
        return !string.IsNullOrEmpty(Bundle.ImageUrl) 
            ? UrlService.GetFileUrl(Bundle.ImageUrl)
            : "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5CdW5kbGU8L3RleHQ+PC9zdmc+";
    }

    private string GetTruncatedDescription()
    {
        if (string.IsNullOrWhiteSpace(Bundle.Description))
            return "No description available";

        return Bundle.Description.Length > 120 
            ? Bundle.Description.Substring(0, 120) + "..." 
            : Bundle.Description;
    }
}