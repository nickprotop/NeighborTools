@using Microsoft.AspNetCore.Components
@using MudBlazor
@using frontend.Models
@using frontend.Services
@using frontend.Components
@inject IRentalService RentalService
@inject IToolService ToolService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">Request Rental - @Tool?.Name</MudText>
        
        @if (Tool != null)
        {
            <MudGrid>
                <MudItem xs="12" Class="mb-4">
                    <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 8px;">
                        <div class="d-flex align-center gap-3">
                            @if (Tool.ImageUrls.Any())
                            {
                                <img src="@Tool.ImageUrls.First()" alt="@Tool.Name" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" />
                            }
                            else
                            {
                                <div class="d-flex align-center justify-center" style="width: 80px; height: 80px; background: var(--mud-palette-surface-variant); border-radius: 8px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Build" Color="Color.Secondary" />
                                </div>
                            }
                            <div>
                                <MudText Typo="Typo.h6">@Tool.Name</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Owner: <UserLink UserId="@Tool.OwnerId" DisplayName="@Tool.OwnerName" ShowAvatar="false" />
                                </MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Location: @Tool.Location</MudText>
                            </div>
                        </div>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="startDate" 
                                   @bind-Date:after="CalculateCost"
                                   Label="Start Date" 
                                   Variant="Variant.Outlined"
                                   MinDate="@GetMinimumStartDate()"
                                   Required="true"
                                   HelperText="@GetStartDateHelperText()" />
                </MudItem>
                
                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="endDate" 
                                   @bind-Date:after="CalculateCost"
                                   Label="End Date" 
                                   Variant="Variant.Outlined"
                                   MinDate="startDate ?? DateTime.Today.AddDays(1)"
                                   Required="true" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="notes" 
                                  Label="Notes (Optional)" 
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  Placeholder="Any special requirements or notes..."
                                  AdornmentIcon="@Icons.Material.Filled.Notes" 
                                  Adornment="Adornment.Start" />
                </MudItem>

                @if (settingsLoaded)
                {
                    <MudItem xs="12">
                        <MudPaper Elevation="1" Class="pa-3" Style="border-radius: 8px; background: var(--mud-palette-surface-variant);">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Rental Information</MudText>
                            <div class="d-flex flex-column gap-1">
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Color="Color.Primary" />
                                    <MudText Typo="Typo.body2">Lead time required: <strong>@ownerLeadTimeHours hours</strong></MudText>
                                </div>
                                @if (autoApprovalEnabled)
                                {
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="Size.Small" Color="Color.Success" />
                                        <MudText Typo="Typo.body2" Color="Color.Success">
                                            <strong>Auto-approval enabled</strong> - Your rental will be confirmed automatically!
                                        </MudText>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2">Owner approval required - You'll receive an email notification once reviewed</MudText>
                                    </div>
                                }
                            </div>
                        </MudPaper>
                    </MudItem>
                }

                @if (totalCost > 0)
                {
                    <MudItem xs="12">
                        <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 8px; background: var(--mud-palette-primary-lighten);">
                            <MudText Typo="Typo.h6" Class="mb-2">Rental Summary</MudText>
                            <MudGrid>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2">Duration:</MudText>
                                    <MudText Typo="Typo.body1"><strong>@rentalDays days</strong></MudText>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2">Rate:</MudText>
                                    <MudText Typo="Typo.body1"><strong>$@selectedRate.ToString("F2") @rateType</strong></MudText>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.body2">Total Cost:</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Primary"><strong>$@totalCost.ToString("F2")</strong></MudText>
                                </MudItem>
                                @if (Tool.DepositRequired > 0)
                                {
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2">Deposit Required:</MudText>
                                        <MudText Typo="Typo.h6" Color="Color.Secondary"><strong>$@Tool.DepositRequired.ToString("F2")</strong></MudText>
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudPaper>
                    </MudItem>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="SubmitRequest"
                   Disabled="@(isSubmitting || !IsFormValid())"
                   StartIcon="@(isSubmitting ? null : Icons.Material.Filled.Send)">
            @if (isSubmitting)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Submitting...</MudText>
            }
            else
            {
                <MudText>Submit Request</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Parameter] public Tool? Tool { get; set; }

    private DateTime? startDate;
    private DateTime? endDate;
    private string notes = string.Empty;
    private string errorMessage = string.Empty;
    private bool isSubmitting = false;
    
    // Cost calculation
    private decimal totalCost = 0;
    private decimal selectedRate = 0;
    private string rateType = "";
    private int rentalDays = 0;

    // Lead time validation
    private int ownerLeadTimeHours = 24; // Default 24 hours, will be fetched from API
    private bool autoApprovalEnabled = false;
    private bool settingsLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        startDate = DateTime.Today.AddDays(1);
        endDate = DateTime.Today.AddDays(2);
        
        // Load owner settings for lead time and auto-approval info
        await LoadOwnerSettings();
        
        CalculateCost();
    }

    private void CalculateCost()
    {
        if (Tool == null || startDate == null || endDate == null || startDate >= endDate)
        {
            totalCost = 0;
            return;
        }

        rentalDays = (int)(endDate.Value - startDate.Value).TotalDays;
        
        // Calculate best rate (similar to backend logic)
        decimal dailyCost = Tool.DailyRate * rentalDays;
        decimal weeklyCost = Tool.WeeklyRate.HasValue && rentalDays >= 7 ? 
            Tool.WeeklyRate.Value * (rentalDays / 7) + Tool.DailyRate * (rentalDays % 7) : decimal.MaxValue;
        decimal monthlyCost = Tool.MonthlyRate.HasValue && rentalDays >= 30 ? 
            Tool.MonthlyRate.Value * (rentalDays / 30) + Tool.DailyRate * (rentalDays % 30) : decimal.MaxValue;

        if (monthlyCost < dailyCost && monthlyCost < weeklyCost)
        {
            totalCost = monthlyCost;
            selectedRate = Tool.MonthlyRate!.Value;
            rateType = "per month";
        }
        else if (weeklyCost < dailyCost)
        {
            totalCost = weeklyCost;
            selectedRate = Tool.WeeklyRate!.Value;
            rateType = "per week";
        }
        else
        {
            totalCost = dailyCost;
            selectedRate = Tool.DailyRate;
            rateType = "per day";
        }

        ValidateLeadTime();
        StateHasChanged();
    }

    private async Task LoadOwnerSettings()
    {
        if (Tool?.Id == null)
        {
            // Use defaults if no tool
            ownerLeadTimeHours = 24;
            autoApprovalEnabled = false;
            settingsLoaded = true;
            return;
        }

        try
        {
            var result = await ToolService.GetToolRentalPreferencesAsync(Tool.Id);
            
            if (result.Success && result.Data != null)
            {
                ownerLeadTimeHours = result.Data.LeadTimeHours;
                autoApprovalEnabled = result.Data.AutoApprovalEnabled;
            }
            else
            {
                // Use defaults if API fails
                ownerLeadTimeHours = 24;
                autoApprovalEnabled = false;
            }
        }
        catch (Exception)
        {
            // Use defaults if exception occurs
            ownerLeadTimeHours = 24;
            autoApprovalEnabled = false;
        }
        finally
        {
            settingsLoaded = true;
            StateHasChanged(); // Refresh UI with loaded settings
        }
    }

    private void ValidateLeadTime()
    {
        if (startDate.HasValue && settingsLoaded)
        {
            var minimumStartTime = DateTime.Now.AddHours(ownerLeadTimeHours);
            
            if (startDate.Value < minimumStartTime)
            {
                errorMessage = $"Rental requests must be made at least {ownerLeadTimeHours} hours in advance. " +
                              $"Earliest available start time: {minimumStartTime:yyyy-MM-dd HH:mm}";
            }
            else if (errorMessage.Contains("must be made at least"))
            {
                errorMessage = string.Empty; // Clear lead time error if now valid
            }
        }
    }

    private bool IsFormValid()
    {
        if (Tool == null || !startDate.HasValue || !endDate.HasValue || startDate >= endDate || totalCost <= 0)
            return false;

        // Check lead time requirement
        if (settingsLoaded)
        {
            var minimumStartTime = DateTime.Now.AddHours(ownerLeadTimeHours);
            if (startDate.Value < minimumStartTime)
                return false;
        }

        return true;
    }

    private DateTime GetMinimumStartDate()
    {
        if (settingsLoaded)
        {
            var minimumStartTime = DateTime.Now.AddHours(ownerLeadTimeHours);
            return minimumStartTime.Date; // Return just the date part for the date picker
        }
        return DateTime.Today.AddDays(1);
    }

    private string GetStartDateHelperText()
    {
        if (settingsLoaded && ownerLeadTimeHours > 24)
        {
            return $"Minimum {ownerLeadTimeHours} hours advance notice required";
        }
        return "Select start date for your rental";
    }

    private async Task SubmitRequest()
    {
        if (!IsFormValid())
            return;

        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            var request = new CreateRentalRequest
            {
                ToolId = Tool!.Id,
                StartDate = startDate!.Value,
                EndDate = endDate!.Value,
                Notes = string.IsNullOrWhiteSpace(notes) ? null : notes
            };

            var result = await RentalService.CreateRentalAsync(request);

            if (result.Success)
            {
                // Show appropriate success message based on response
                var successMessage = result.Message ?? "Rental request submitted successfully!";
                var severity = result.Message?.Contains("automatically approved") == true ? Severity.Success : Severity.Info;
                
                Snackbar.Add(successMessage, severity);
                MudDialog.Close(DialogResult.Ok(result.Data));
            }
            else
            {
                errorMessage = result.Message ?? "Failed to submit rental request.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}